# Steps to run the controller

1. Clone the repository in your local system and make necessary arrangements for a running cluster. (I have locally used minikube v1.15.1 and k8s v1.19.4)

2. Navigate into the cloned repository.

3. Define a CRD using the command: ```kubectl kustomize ./config/crd | kubectl apply -f -``` 
   (PS: It throws a warning on my end as:
   ```
   Warning: apiextensions.k8s.io/v1beta1 CustomResourceDefinition is deprecated in v1.16+, unavailable in v1.22+; use apiextensions.k8s.io/v1 CustomResourceDefinition
   ```
   But this can be ignored as of now) Terminal will show a message that says a custom resource has been defined:
   ```
   customresourcedefinition.apiextensions.k8s.io/fruits.plants.siddharth.com created
   ```
   
  4. One can check the CRDs present using the command: ```kubectl get crds```
     
     This shows all the CRDs available:
     ```
     NAME                          CREATED AT
     fruits.plants.siddharth.com   2020-12-06T21:20:21Z
     ```
     
  5. Create a namespace, suppose "fruit" (```kubectl create namespace fruits```)
  
  6. Run the custom controller locally by ```make run```(look into the MakeFile for more info of what goes behind the scenes) and open another terminal and execute the next commands.
  
  7. A sample yaml file specifying the nature of CRD is kept at ```./config/samples/plants_v1alpha1_fruit.yaml```.
  
     Apply the yaml (using ```kubectl apply -f ./config/samples/plants_v1alpha1_fruit.yaml```)  to see the custom resource getting instantiated.
     
  8. One can check the status of deployment and pods to see the current scenario.
  
     Deployments:
     ```
     NAMESPACE     NAME           READY   UP-TO-DATE   AVAILABLE   AGE
     fruit         fruit-sample   5/5     5            5           101s
     kube-system   coredns        1/1     1            1           2d1h
     ```
  
     Pods:
     ```
     NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
     fruit         fruit-sample-68774ffdff-69bwq      1/1     Running   0          15m
     fruit         fruit-sample-68774ffdff-8zpfj      1/1     Running   0          15m
     fruit         fruit-sample-68774ffdff-p8bmp      1/1     Running   0          15m
     fruit         fruit-sample-68774ffdff-s7js9      1/1     Running   0          15m
     fruit         fruit-sample-68774ffdff-zbtcm      1/1     Running   0          15m
     kube-system   coredns-f9fd979d6-zttnb            1/1     Running   6          2d
     kube-system   etcd-minikube                      1/1     Running   6          2d
     kube-system   kube-apiserver-minikube            1/1     Running   6          2d
     kube-system   kube-controller-manager-minikube   1/1     Running   6          2d
     kube-system   kube-proxy-lklnl                   1/1     Running   6          2d
     kube-system   kube-scheduler-minikube            1/1     Running   6          2d
     kube-system   storage-provisioner                1/1     Running   10         2d
     ```
     All these fruit-sample pods are running `nginx:1.14.2` image.
     
  9. One can also expose a service (a loadbalancer service) using service.yaml and curl into the external IP address to see a hello message.
     Services:
     ```
     NAMESPACE     NAME           TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
     default       kubernetes     ClusterIP      10.96.0.1       <none>        443/TCP                  2d
     fruit         fruit-sample   LoadBalancer   10.104.92.216   <pending>     80:30019/TCP             7m34s
     kube-system   kube-dns       ClusterIP      10.96.0.10      <none>        53/UDP,53/TCP,9153/TCP   2d
     ```
     
  10. For deleting deployment, one can:
     ```
     kubectl delete deployment -n fruit fruit-sample
     ```
  
  11. One can also delete the existing pods (custom resources ones) and see them getting re-generated by the controller.
  
  All the initial boilerplate code is generated using kubebuilder.
